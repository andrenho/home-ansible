---

# TODO - remove
- name: Clone homeserver repository
  git:
    repo: "https://{{ git_username }}:{{ git_password }}@github.com/andrenho/homeserver.git"
    dest: "{{ homeserver_path }}"
    version: home-network   # TODO - remove

- name: Build images (this can take a long time)
  community.general.docker_compose:
    build: yes
    project_src: "{{ homeserver_path }}"
    state: absent
    stopped: yes

- name: Create service
  template:
    src: docker-compose-app.service
    dest: /etc/systemd/system/docker-compose-app.service

- name: Create env file
  template:
    src: docker-env
    dest: "{{ docker_env_file }}"

- name: Create sftp secrets file
  shell:
    creates: /root/sftp-users.conf
    cmd: echo "{{ homeserver_user }}:$(echo -n '{{ homeserver_password }}' | docker run -i --rm atmoz/makepasswd --crypt-md5 --clearfrom=- | awk -F ' ' '{print $2}'):{{ admin_uid }}:1000" > /root/sftp-users.conf

- name: Start and enable service
  service:
    name: docker-compose-app
    state: started    # TODO - restart service
    enabled: true

# TODO - services
#   - ftp
#   - sftp
#   - nginx (partial), partainer
#   - pihole
#   - dynamicdns, backup
#   - mqtt, dnla
#   - homer (configure yaml file)
#   - dokuwiki, portainer, openbooks
#   - ssh, explorer
#   - sonarr, radarr, bazarr
#   - cyberchef, audioserve, hoppscotch
#   - rss, rss-db
#   - ubooquity, podgrab
#   - torrent
#   - plex
#   - dev


# TODO - create password files (nginx, sftp, etc)
# TODO - configure docker compose
# TODO - install dash and install/start service
# TODO - create docker service and install/start service
